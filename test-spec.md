# テスト仕様書: Flask + OpenRouter AI チャットアプリ

## 1. テスト対象
- `app.py`（Flaskサーバー/APIバックエンド）
- `static/index.html`（フロントエンドUI）

## 2. テスト環境
- OS: Windows 11  
- Python 3.8 以降  
- 必須ライブラリ: Flask, requests, python-dotenv  
- OpenRouter APIキー設定済み  
- ブラウザ: Chrome, Edge, Brave

## 3. テスト項目

### 3.1. サーバー起動・静的ファイル配信
| No | テスト内容 | 手順 | 期待結果 | 
|----|------------|------|----------|
| 1 | サーバー起動 | ターミナルで python app.py を実行 | エラーなく起動し http://localhost:5000/ にアクセス可能 
| 2 | index.html配信 | ブラウザで http://localhost:5000/ にアクセス | フロントエンドUIが正しく表示 |
| 3 | 静的ファイル配信 | 画像/フォント/Tailwind 読み込みを確認 | すべて 200 応答で正常表示 |

### 3.2. 冷蔵庫機能（UI/サーバー連携）
| No | テスト内容 | 手順 | 期待結果 |
|----|------------|------|----------|
| 4  | 食材追加（D&D) | 画像をドロップ→期限/数量/単位/カテゴリ/保管入力→「追加」| カード表示・`/api/items` が 201・`data/items.json` 保存 |
| 5  | 食材追加（選択）| 画像をクリック選択→期限/数量/単位/カテゴリ/保管入力→「追加」| カード表示・`/api/items` が 201・`data/items.json` 保存 |                                             |
| 6  | 拡張子バリデーション | 非対応拡張子をアップロード | /api/items` が 400 `{"error":"invalid image"} |
| 7  | 自動命名（Vision） | APIキー設定済みで食材画像を追加 | name` 未指定でも日本語1語の推定名が入る（失敗時はファイル名）|
| 8  | 一覧表示 | 追加後に一覧を確認 | 画像/名称/期限/バッジ/個数/チップが表示 |
| 9  | 詳細編集 | カード画像をクリック→編集→保存 | `/api/items/<id>` PATCH 200、表示更新 |
| 10 | 単体削除+Undo | 🗑→確認OK→トーストの「元に戻す」| DELETE 成功→`/api/undo_delete` で復元（90秒以内）|
| 11 | バルク選択 | 複数カードにチェック | 件数表示・バルクバー表示 |
| 12 | 一括削除 | バルクバー「選択を削除」→確認OK | /api/items/bulk_delete` 200、対象が非表示 |
| 13 | 一括アーカイブ | バルクバー「選択をアーカイブ」| /api/items/bulk_update` 200、アーカイブ状態 |
| 14 | 一括在庫0  | バルクバー「在庫を0に」| 数量が 0、表示は「在庫なし」|
| 15 | 一括編集 |「一括編集」→各項目設定→適用 | `/api/items/bulk_update` 200、反映 |
| 16 | 検索 | 検索ボックスに語を入力 | 部分一致で絞り込み |
| 17 | 並び替え | プルダウンで基準を変更 | 並び順が反映 |
| 18 | 期限系フィルタ | 「今日/明日/明後日」「今週まで」「期限切れ」選択 | 条件に合致するカードのみ表示 |
| 19 | 在庫/アーカイブフィルタ | 「在庫0」「アーカイブ」選択 | 条件に合致するカードのみ表示 |
| 20 | トグル表示 |「在庫0も表示」「アーカイブも表示」ON/OFF | 一覧表示が切り替わる |
| 21 | ステータスカウント | 追加/編集/削除の度に確認 | 合計/要消費/期限切れが正しい |
| 22 | 空状態表示 | アイテム0件 | 空状態案内・献立欄に「冷蔵庫が空です…」表示 |

### 3.3. /api/recipes（献立提案）正常系
| No | テスト内容 | 手順 | 期待結果 |
|----|------------|------|----------|
| 23 | 選択で献立提案 | 複数選択→「選択で献立提案」 | /api/recipes 200、{recipes:[], source:"ai"|"fallback"} |
| 24 | JSONレンダリング | 返却の各フィールドを確認 | タイトル/材料/手順/タグ/時間が整形表示 |
| 25 | 冷蔵庫が空 | 0件で「選択で献立提案」 | 「冷蔵庫が空です。」または候補なし表示 |
| 26 | フォールバック | APIキー未設定/モデル未指定 | source:"fallback" で簡易レシピ返却・リンク付 |
| 27 | 似たレシピリンク | レシピの url をクリック | 新規タブで検索結果が開く |

### 3.4. /api/recipes（献立提案）異常系（自動フォールバック）
| No | テスト内容 | 手順 | 期待結果 |
|----|------------|------|----------|
| 28 | APIキー未設定 | .env の OPENROUTER_API_KEY を空 | LLMスキップ→source:"fallback" で正常応答 |
| 29 | クレジット不足/Timeout | OpenRouterをタイムアウト/エラーにする | 例外捕捉→source:"fallback" で正常応答 |
| 30 | 応答形式異常 | LLMから不正JSON（モック） | パース失敗→source:"fallback" で正常応答 |

### 3.5. 画像・Seed スキャン
| No | テスト内容 | 手順 | 期待結果 |
|----|------------|------|----------|
| 31 | Seed 再スキャン | 「イメージスキャン」→/api/seed/rescan | {"added":N,"found":M}、新規画像が追加 |
| 32 | Seed URL整合 | static/images に画像→再スキャン | カード画像が表示（パス不整合なし） |

### 3.6. そのほかAPI
| No | テスト内容 | 手順 | 期待結果 |
|----|------------|------|----------|
| 33 | /api/meta | GET /api/meta | 単位/カテゴリ/保管の配列が返る |
| 34 | /api/items 検索等 | GET ?query=...&sort=expiry&order=asc&filter=near_due&include_zero=true&include_archived=true | 絞り込み/並び替えが想定どおり |
| 35 | /api/items PATCH | 任意IDに JSON で更新 | 200で保存・再取得で反映 |
| 36 | /api/items/consume | POST {items:[{id,amount}]} | 指定量だけ数量減算（0未満にならない） |
| 37 | /api/undo_delete | 削除直後90秒以内に POST | 指定IDが復元 |
| 38 | /api/shopping_list | POST {requirements:[...]} | 不足分がshortageで返る |
| 39 | /api/substitutes（固定）| GET ?name=長ねぎ | 既定の代替候補が返る |
| 40 | /api/substitutes（LLM）| 固定にない名称 + APIキー設定 | LLM候補配列（失敗時は空配列）|

### 3.7. UI/UX・アクセシビリティ
| No | テスト内容 | 手順 | 期待結果 |
|----|------------|------|----------|
| 41 | トースト自動消滅 | 削除後のトーストを観察 | 約3.5秒で自動的に非表示 |
| 42 | ダーク/ライト切替 | テーマボタンをクリック | テーマ切替・localStorage 保存 |
| 43 | レスポンシブ | スマホ/タブレット幅で確認 | グリッド/カードが崩れない |
| 44 | キーボード操作 | フォーカス移動/Enter操作 | 入力・ボタン操作が可能 |

### 3.8. 永続化・復元
| No | テスト内容 | 手順 | 期待結果 |
|----|------------|------|----------|
| 45 | データ永続化 | 追加→サーバー再起動 | data/items.json から復元され一覧表示 |
| 46 | 画像物理削除 | アップロード済みを削除 | /static/uploads/<uuid>.* が物理削除（存在すれば）|

### 3.9. パフォーマンス・安定性
| No | テスト内容 | 手順 | 期待結果 |
|----|------------|------|----------|
| 47 | レンダリング速度 | 20〜50件のアイテムで操作 | 再描画がストレスなく行える |
| 48 | 献立応答速度 | 数種類選択→献立提案 | 目安5秒以内（フォールバックはより速い） |
| 49 | 大画像アップロード | 5MB超の画像を追加 | 正常追加・サーバーがタイムアウトしない |

---
💡 **補足**

- AI応答は `max_tokens` を適切に制限して無料枠で動作することを確認  
- エラーケースでは、フロントエンドに適切にエラーメッセージを表示すること
