<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <title>食材管理 & 献立提案</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            jp: ['"Noto Sans JP"', 'system-ui', 'sans-serif'],
            ui: ['Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            brand: {50:"#fff7ed",100:"#ffedd5",500:"#f59e0b",600:"#d97706",700:"#b45309"},
          },
          boxShadow: {
            soft: "0 10px 30px -12px rgba(0,0,0,.28)",
            glow: "0 10px 30px -10px rgba(245,158,11,.45)",
          },
          keyframes: {
            float: { '0%,100%': { transform:'translateY(0)' }, '50%': { transform:'translateY(-6px)' } },
            pop: { '0%': { transform:'scale(.96)', opacity:.0 }, '100%': { transform:'scale(1)', opacity:1 } },
          },
          animation: {
            float: 'float 6s ease-in-out infinite',
            pop: 'pop .2s ease-out forwards',
          }
        }
      }
    };
  </script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root { --bg-grid: radial-gradient(circle at 1px 1px, rgba(0,0,0,.06) 1px, transparent 0); }
    .pattern {
      background-image: var(--bg-grid);
      background-size: 16px 16px;
      mask-image: radial-gradient(ellipse at center, rgba(0,0,0,.9), rgba(0,0,0,.35) 60%, transparent 70%);
    }
    .dropzone { border: 2px dashed #cbd5e1; }
    .dropzone.dragover { border-color:#f59e0b; background:#fff7ed; }
    .modal-bg { background: rgba(0,0,0,.45); backdrop-filter: blur(4px); }
    .skeleton { background: linear-gradient(90deg, rgba(0,0,0,.06) 25%, rgba(0,0,0,.12) 37%, rgba(0,0,0,.06) 63%); background-size: 700px 100%; animation: shimmer 2.2s linear infinite; }
    @keyframes shimmer { 0%{background-position:-700px 0}100%{background-position:700px 0} }
    /* カードの微グロー */
    .card-glass { position: relative; }
    .card-glass::after{
      content:""; position:absolute; inset:0; border-radius:1rem;
      background: radial-gradient(120px 80px at 20% 0%, rgba(245,158,11,.18), transparent 60%),
                  radial-gradient(120px 80px at 100% 0%, rgba(236,72,153,.14), transparent 60%);
      opacity:.65; pointer-events:none; mix-blend:overlay;
    }
    .chip { box-shadow: inset 0 1px 0 rgba(255,255,255,.2); }
    /* ==== Dark Cool Mode polish ==== */
    :root {
      --accent: #22d3ee;   /* cyan */
      --accent-2: #a78bfa; /* violet */
      --ring: rgba(34,211,238,.35);
    }
    

    /* 背景にうっすらアニメーションするグラデのベール */
    body.dark::before{
      content:"";
      position: fixed; inset:0; z-index:-1;
      pointer-events:none;
      background:
        radial-gradient(60rem 40rem at 10% -10%, rgba(34,211,238,.10), transparent 60%),
        radial-gradient(60rem 40rem at 110% 10%, rgba(167,139,250,.10), transparent 60%),
        radial-gradient(30rem 20rem at 50% 120%, rgba(56,189,248,.06), transparent 60%);
      filter: saturate(110%);
      animation: bgFloat 18s ease-in-out infinite alternate;
    }
    @keyframes bgFloat {
      0%   { transform: translateY(0) scale(1);   opacity:.9; }
      100% { transform: translateY(-6px) scale(1.02); opacity:1; }
    }

    /* トップバーを薄いガラス化＋下線を控えめに */
    .dark .sticky{
      background: rgba(17,17,18,.55) !important;
      backdrop-filter: blur(8px);
      border-color: rgba(255,255,255,.06) !important;
    }

    /* カードのガラスと縁取りをクールに */
    .dark .card-glass{
      background: linear-gradient(180deg, rgba(24,24,27,.65), rgba(24,24,27,.55));
      border: 1px solid rgba(255,255,255,.06) !important;
      box-shadow:
        0 10px 30px -14px rgba(0,0,0,.5),
        0 1px 0 rgba(255,255,255,.03) inset;
    }
    .dark .card-glass::after{
      background:
        radial-gradient(140px 90px at 15% -10%, rgba(34,211,238,.18), transparent 60%),
        radial-gradient(140px 90px at 110% 0%, rgba(167,139,250,.16), transparent 60%);
      opacity:.75;
    }

    /* 画像は暗所でコントラストを少しだけ上げる。hoverでシャープに */
    .dark .card-img{
      filter: contrast(1.05) saturate(1.05) brightness(.98);
      transition: filter .25s ease, transform .25s ease;
    }
    .dark .group:hover .card-img{
      filter: contrast(1.15) saturate(1.1) brightness(1.02);
    }

    /* バッジやチップはネオン寄りに */
    .dark .qty-badge{ 
      box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset, 0 0 10px rgba(34,211,238,.18);
    }
    .dark .chip, .dark .chip-unit, .dark .chip-cat, .dark .chip-loc{
      background: rgba(255,255,255,.06) !important;
      border: 1px solid rgba(255,255,255,.06);
    }

    /* 期限バッジの発光を少し追加（色は既存のまま） */
    .dark .expiry-badge{
      box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset, 0 0 12px rgba(167,139,250,.16);
    }

    /* ボタン：hoverで淡いシアンのリング */
    .dark .shadow-soft:hover{
      box-shadow:
        0 0 0 1px var(--ring),
        0 10px 30px -12px rgba(0,0,0,.5);
    }
    .dark .shadow-glow{
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06) inset,
        0 0 28px -10px rgba(34,211,238,.35),
        0 10px 30px -12px rgba(0,0,0,.58) !important;
    }

    /* 入力・セレクトの境界線をスッと */
    .dark input, .dark select{
      border-color: rgba(255,255,255,.08) !important;
    }
    .dark input:focus, .dark select:focus{
      box-shadow: 0 0 0 3px rgba(34,211,238,.20);
      border-color: rgba(34,211,238,.45) !important;
    }

    /* モーダルもクールガラス */
    .dark .modal-bg{ background: rgba(2,6,23,.55); backdrop-filter: blur(8px); }
    .dark #detailModal > div, .dark #bulkModal > div{
      background: linear-gradient(180deg, rgba(17,24,39,.85), rgba(17,24,39,.75));
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: 0 18px 50px -20px rgba(0,0,0,.8), 0 0 0 1px rgba(255,255,255,.03) inset;
    }

    /* 空表示のボックスも統一感 */
    .dark #items .grid > .col-span-full .border{
      border-color: rgba(255,255,255,.06) !important;
      background: linear-gradient(180deg, rgba(24,24,27,.55), rgba(24,24,27,.45)) !important;
    }

    /* スクロールバー（ダーク） */
    .dark ::-webkit-scrollbar{ height:12px; width:12px; }
    .dark ::-webkit-scrollbar-thumb{
      background: linear-gradient(180deg, rgba(34,211,238,.35), rgba(167,139,250,.35));
      border-radius: 999px;
      border: 3px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }
    .dark ::-webkit-scrollbar-track{ background: transparent; }

    /* 小さな発光ライン（下線に使う） */
    .dm-underline{
    position: relative;
    }
    .dark .dm-underline::after{
      content:""; position:absolute; left:0; right:0; bottom:-2px; height:1px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      opacity:.6;
    }
    /* ===== Ultimate Cool Dark Mode ===== */
:root{
  --c1:#22d3ee; /* cyan */
  --c2:#a78bfa; /* violet */
  --ang: 0deg;
}

/* オーロラ + きらめき */
body.dark::before{
  content:""; position:fixed; inset:0; z-index:-2; pointer-events:none;
  background:
    radial-gradient(60rem 40rem at 10% -10%, rgba(34,211,238,.12), transparent 60%),
    radial-gradient(60rem 40rem at 110% 10%, rgba(167,139,250,.12), transparent 60%),
    radial-gradient(26rem 22rem at 50% 120%, rgba(56,189,248,.08), transparent 60%);
  animation:bgFloat 18s ease-in-out infinite alternate;
}
body.dark::after{
  content:""; position:fixed; inset:-20% -10%; z-index:-3; pointer-events:none;
  background: conic-gradient(from var(--ang),
              rgba(34,211,238,.10), rgba(167,139,250,.10), rgba(34,211,238,.10));
  filter: blur(40px); opacity:.55;
}
@keyframes bgFloat{0%{transform:translateY(0)}100%{transform:translateY(-8px)}}

/* カード：ネオン境界＋グレア（.card-glass に重ねがけ用） */
.dark .card-cool{
  position:relative;
  background: linear-gradient(180deg, rgba(17,24,39,.72), rgba(17,24,39,.62));
  border:1px solid rgba(255,255,255,.06) !important;
  backdrop-filter: blur(10px) saturate(115%);
  box-shadow: 0 14px 38px -18px rgba(0,0,0,.75), 0 1px 0 rgba(255,255,255,.03) inset;
  will-change: transform;
}
.dark .card-cool::before{
  content:""; position:absolute; inset:-1px; border-radius:inherit; padding:1px;
  background: linear-gradient(135deg, var(--c1), var(--c2));
  -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite: xor; mask-composite: exclude;
  animation:borderHue 7s linear infinite; opacity:.75;
}
.dark .card-cool::after{
  content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
  background: radial-gradient(60% 40% at var(--mx,40%) var(--my,35%),
              rgba(255,255,255,.06), transparent 60%);
  transition: background-position .05s linear;
}
@keyframes borderHue{to{filter:hue-rotate(360deg)}}

/* 画像のコントラスト強化 */
.dark .card-img{ filter: contrast(1.1) saturate(1.08) brightness(1.02); }

/* 進捗バーをネオン化 */
.dark .progress{
  background: linear-gradient(90deg, var(--c1), var(--c2)) !important;
  box-shadow: 0 0 14px rgba(34,211,238,.25);
}

/* ボタン：ホログラフィック */
.dark .btn-cool{
  position:relative; overflow:hidden;
  border:1px solid rgba(255,255,255,.08) !important;
  background: linear-gradient(180deg, rgba(18,24,38,.85), rgba(18,24,38,.65));
  box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset,
              0 12px 32px -14px rgba(0,0,0,.7),
              0 0 26px -10px rgba(34,211,238,.35);
  transition: transform .15s ease, box-shadow .15s ease;
}
.dark .btn-cool::after{
  content:""; position:absolute; inset:-1px; pointer-events:none;
  background: conic-gradient(from var(--ang), var(--c1), var(--c2), var(--c1));
  mix-blend-mode: screen; filter: blur(18px); opacity:.65; transition:opacity .2s;
}
.dark .btn-cool:hover{ transform: translateY(-1px); }
.dark .btn-cool:hover::after{ opacity:.9; }

/* 見出し：グラデ文字＋ネオン下線 */
.dark .heading-cool{
  background: linear-gradient(90deg, var(--c1), var(--c2));
  -webkit-background-clip:text; background-clip:text; color:transparent;
  text-shadow: 0 0 14px rgba(167,139,250,.25);
  position:relative;
}
.dark .heading-cool::after{
  content:""; position:absolute; left:0; right:0; bottom:-6px; height:1px;
  background: linear-gradient(90deg, transparent, var(--c1), var(--c2), transparent);
  opacity:.6;
}

/* スクロールバー */
.dark ::-webkit-scrollbar{ width:12px; height:12px; }
.dark ::-webkit-scrollbar-thumb{
  background: linear-gradient(180deg, rgba(34,211,238,.45), rgba(167,139,250,.45));
  border-radius:999px; border:3px solid transparent; background-clip: padding-box;
}

  </style>
</head>
<body class="font-jp bg-gradient-to-b from-amber-50 to-white text-gray-900 dark:from-zinc-900 dark:to-zinc-950 dark:text-zinc-100">
  <!-- Top Bar -->
  <div class="sticky top-0 z-40 backdrop-blur bg-white/70 dark:bg-zinc-900/60 border-b border-white/50 dark:border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3 justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-amber-400 to-rose-400 grid place-items-center shadow-soft animate-float">🍳</div>
        <h1 class="text-xl md:text-2xl font-bold tracking-tight">食材管理 &amp; 献立提案</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnRescan" class="inline-flex items-center gap-2 px-3.5 py-2 rounded-xl bg-amber-500 text-white hover:bg-amber-600 active:scale-[.98] transition shadow-glow btn-cool">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M3 12a9 9 0 1 1 3 6.708" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M3 16v-4h4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
          <span>イメージスキャン</span>
        </button>
        <button id="btnTheme" class="inline-flex items-center justify-center w-10 h-10 rounded-xl border border-black/10 dark:border-white/10 hover:bg-black/5 dark:hover:bg-white/5 shadow-soft">
          <span class="sr-only">テーマ切替</span>
          <svg id="iconSun" class="w-5 h-5 block dark:hidden" viewBox="0 0 24 24" fill="none"><path d="M12 4v2m0 12v2M4 12H2m20 0h-2M5 5l1.5 1.5M17.5 17.5L19 19M19 5l-1.5 1.5M6.5 17.5L5 19" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.6"/></svg>
          <svg id="iconMoon" class="w-5 h-5 hidden dark:block" viewBox="0 0 24 24" fill="none"><path d="M20 12.5A8.5 8.5 0 1 1 11.5 4 7 7 0 0 0 20 12.5Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Hero -->
  <div class="relative overflow-hidden">
    <div class="absolute inset-0 pattern opacity-50 dark:opacity-40"></div>
    <div class="max-w-7xl mx-auto px-6 py-8 md:py-12 relative">
      <div class="rounded-3xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-zinc-900/60 backdrop-blur shadow-soft p-6 md:p-8 card-glass shadow-glow card-cool">
        <div class="flex flex-col md:flex-row items-start md:items-center gap-5 md:gap-8 justify-between">
          <div>
            <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight heading-cool">
            冷蔵庫を“見える化”して、<span class="bg-gradient-to-r from-amber-500 via-rose-500 to-emerald-500 bg-clip-text text-transparent">ムダゼロのごはん計画</span>
            </h2>

            <p class="mt-2 text-sm md:text-base text-gray-600 dark:text-zinc-300">
      
            </p>
          </div>
          <!-- Stats -->
          <div class="grid grid-cols-3 gap-3 w-full md:w-auto">
            <div class="rounded-2xl px-4 py-3 bg-white/80 dark:bg-zinc-800/70 border border-black/10 dark:border-white/10 text-center shadow-soft">
              <div class="text-[11px] text-gray-500 dark:text-zinc-400">合計</div>
              <div id="statTotal" class="text-xl font-bold">0</div>
            </div>
            <div class="rounded-2xl px-4 py-3 bg-white/80 dark:bg-zinc-800/70 border border-black/10 dark:border-white/10 text-center shadow-soft">
              <div class="text-[11px] text-gray-500 dark:text-zinc-400">要消費</div>
              <div id="statNear" class="text-xl font-bold">0</div>
            </div>
            <div class="rounded-2xl px-4 py-3 bg-white/80 dark:bg-zinc-800/70 border border-black/10 dark:border-white/10 text-center shadow-soft">
              <div class="text-[11px] text-gray-500 dark:text-zinc-400">期限切れ</div>
              <div id="statExpired" class="text-xl font-bold">0</div>
            </div>
          </div>
        </div>
        <!-- Quick filters -->
        <div class="mt-4 flex flex-wrap gap-2">
          <button class="qf chip px-3 py-1.5 rounded-full text-sm bg-black/5 dark:bg-white/10 hover:bg-black/10 dark:hover:bg-white/15 transition" data-filter="">すべて</button>
          <button class="qf chip px-3 py-1.5 rounded-full text-sm bg-amber-100/70 text-amber-900 dark:bg-amber-500/20 dark:text-amber-200 hover:brightness-110" data-filter="near_due">今日・明日・明後日</button>
          <button class="qf chip px-3 py-1.5 rounded-full text-sm bg-rose-100/70 text-rose-900 dark:bg-rose-500/20 dark:text-rose-200 hover:brightness-110" data-filter="expired">期限切れ</button>
          <button class="qf chip px-3 py-1.5 rounded-full text-sm bg-emerald-100/70 text-emerald-900 dark:bg-emerald-500/20 dark:text-emerald-200 hover:brightness-110" data-filter="this_week">今週まで</button>
          <button class="qf chip px-3 py-1.5 rounded-full text-sm bg-slate-100/70 text-slate-900 dark:bg-slate-500/20 dark:text-slate-200 hover:brightness-110" data-filter="out_of_stock">在庫0</button>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto p-6 space-y-8">
    <!-- コントロールバー：検索/並び替え/フィルタ/マスター選択 -->
    <section class="rounded-2xl bg-white/70 dark:bg-zinc-900/60 border border-black/10 dark:border-white/10 shadow-soft p-4">
      <div class="flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
        <div class="flex gap-2 flex-1">
          <div class="relative flex-1">
            <input id="searchBox" type="search" placeholder="食材名・カテゴリで検索"
                   class="w-full rounded-xl border border-black/10 dark:border-white/10 bg-white/80 dark:bg-zinc-900/70 px-10 py-2 outline-none focus:ring-2 focus:ring-amber-400/60">
            <svg class="w-4 h-4 absolute left-3 top-2.5 opacity-70" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.6"/><path d="m20 20-3-3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
          </div>
          <select id="sortSelect" class="rounded-xl border border-black/10 dark:border-white/10 bg-white/80 dark:bg-zinc-900/70 px-3 py-2">
            <option value="name|asc">名前 ↑</option>
            <option value="name|desc">名前 ↓</option>
            <option value="expiry|asc">期限が近い順</option>
            <option value="expiry|desc">期限が遠い順</option>
            <option value="created|desc">新規追加順</option>
            <option value="created|asc">古い順</option>
            <option value="quantity|desc">個数 多い順</option>
            <option value="quantity|asc">個数 少ない順</option>
          </select>
          <select id="filterSelect" class="rounded-xl border border-black/10 dark:border-white/10 bg-white/80 dark:bg-zinc-900/70 px-3 py-2">
            <option value="">フィルタなし</option>
            <option value="near_due">今日/明日/明後日</option>
            <option value="this_week">今週まで</option>
            <option value="expired">期限切れ</option>
            <option value="out_of_stock">在庫0</option>
            <option value="archived">アーカイブ</option>
          </select>
          <label class="inline-flex items-center gap-1 text-sm px-2">
            <input id="toggleZero" type="checkbox" class="w-4 h-4"> 在庫0も表示
          </label>
          <label class="inline-flex items-center gap-1 text-sm px-2">
            <input id="toggleArchived" type="checkbox" class="w-4 h-4"> アーカイブも表示
          </label>
        </div>

        <div class="flex items-center gap-3">
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="masterCheck" type="checkbox" class="w-4 h-4 rounded border-gray-300"> すべて選択
          </label>
          <span id="selCount" class="text-sm text-gray-500 dark:text-zinc-400">0 件選択中</span>
        </div>
      </div>
    </section>

    <!-- 追加フォーム -->
    <section class="rounded-2xl bg-white/70 dark:bg-zinc-900/60 border border-black/10 dark:border-white/10 shadow-soft p-6 space-y-5">
      <div class="grid gap-4 md:grid-cols-5">
        <div class="space-y-2">
          <label class="block text-sm">消費期限（任意）</label>
          <input id="expiry" type="date" class="w-full border rounded-xl px-3 py-2 bg-white/80 dark:bg-zinc-900/70 border-black/10 dark:border-white/10 focus:outline-none focus:ring-2 focus:ring-amber-400/60">
        </div>
        <div class="space-y-2">
          <label class="block text-sm">個数</label>
          <input id="qty" type="number" min="0" max="999" value="1" class="w-full border rounded-xl px-3 py-2 bg-white/80 dark:bg-zinc-900/70 border-black/10 dark:border-white/10">
        </div>
        <div class="space-y-2">
          <label class="block text-sm">単位</label>
          <select id="unit" class="w-full border rounded-xl px-3 py-2 bg-white/80 dark:bg-zinc-900/70 border-black/10 dark:border-white/10"></select>
        </div>
        <div class="space-y-2">
          <label class="block text-sm">カテゴリ</label>
          <select id="category" class="w-full border rounded-xl px-3 py-2 bg-white/80 dark:bg-zinc-900/70 border-black/10 dark:border-white/10"></select>
        </div>
        <div class="space-y-2">
          <label class="block text-sm">保管</label>
          <select id="location" class="w-full border rounded-xl px-3 py-2 bg-white/80 dark:bg-zinc-900/70 border-black/10 dark:border-white/10"></select>
        </div>
      </div>
      <div class="grid gap-4 md:grid-cols-2">
        <div class="space-y-2">
          <label class="block text-sm">画像</label>
          <div id="dropzone" class="dropzone rounded-2xl p-6 text-center text-gray-600 dark:text-zinc-300 cursor-pointer bg-white/60 dark:bg-zinc-900/50 border-black/10 dark:border-white/10 hover:shadow-soft transition">
            ここに画像をドラッグ＆ドロップ<br><span class="text-xs">(クリックしてファイル選択も可)</span>
            <input id="file" type="file" accept="image/*" class="hidden" />
          </div>
          <div id="preview" class="hidden mt-2 text-xs text-gray-500 dark:text-zinc-400"></div>
        </div>
        <div class="flex items-end gap-3">
          <button id="btnUpload" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 active:scale-[.98] transition shadow-soft">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M12 16V8m0 0-3 3m3-3 3 3M5 17v2h14v-2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            追加
          </button>
          <button id="btnSuggest" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 active:scale-[.98] transition shadow-soft btn-cool">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="m3 12 6 6L21 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
            選択で献立提案
          </button>
          <span id="msg" class="text-sm text-gray-500 dark:text-zinc-400"></span>
        </div>
      </div>
    </section>

    <!-- バルク操作バー -->
    <section id="bulkBar" class="hidden rounded-2xl bg-white/70 dark:bg-zinc-900/60 border border-black/10 dark:border-white/10 shadow-soft p-4">
      <div class="flex flex-wrap items-center gap-2">
        <button id="btnBulkDelete" class="px-3 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">選択を削除</button>
        <button id="btnBulkArchive" class="px-3 py-2 rounded-lg bg-slate-600 text-white hover:bg-slate-700">選択をアーカイブ</button>
        <button id="btnBulkZero" class="px-3 py-2 rounded-lg bg-amber-600 text-white hover:bg-amber-700">在庫を0に</button>
        <button id="btnBulkEdit" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">一括編集</button>
      </div>
    </section>

    <!-- 一覧 & 操作 -->
    <section class="space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold text-lg md:text-xl heading-cool">冷蔵庫の中身</h2>
      </div>

      <!-- スケルトン -->
      <div id="skeleton" class="grid gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
        <div class="rounded-2xl h-56 skeleton"></div>
        <div class="rounded-2xl h-56 skeleton"></div>
        <div class="rounded-2xl h-56 skeleton"></div>
        <div class="rounded-2xl h-56 skeleton"></div>
      </div>

      <div id="items" class="grid gap-5 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 hidden"></div>
    </section>

    <!-- レシピ結果 -->
    <section class="rounded-2xl bg-white/70 dark:bg-zinc-900/60 border border-black/10 dark:border-white/10 shadow-soft p-6 space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold text-lg md:text-xl heading-cool">献立提案</h2>
        <span id="aiBadge" class="hidden text-xs px-2 py-1 rounded-full bg-violet-600 text-white">AI生成</span>
      </div>
      <div id="recipes" class="space-y-4 text-sm text-gray-700 dark:text-zinc-200"></div>
    </section>
  </div>

  <!-- 詳細/編集モーダル -->
  <div id="detailModal" class="fixed inset-0 hidden items-center justify-center modal-bg z-50">
    <div class="bg-white dark:bg-zinc-900 w-11/12 max-w-md rounded-2xl shadow-xl p-5 space-y-4 border border-black/10 dark:border-white/10">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">食材の編集</h3>
        <button id="modalClose" class="text-gray-500 hover:text-gray-700 dark:hover:text-zinc-200 text-xl leading-none">&times;</button>
      </div>
      <div class="space-y-3">
        <img id="modalImg" class="w-full h-48 object-cover rounded-lg border border-black/10 dark:border-white/10" alt="item image"/>
        <div>
          <div class="text-sm text-gray-500 dark:text-zinc-400">食材名</div>
          <div id="modalName" class="text-base font-medium"></div>
        </div>
        <div id="buyLinks" class="pt-2 border-t border-black/10 dark:border-white/10 text-sm"></div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">消費期限</label>
            <input id="modalExpiryInput" type="date" class="w-full border rounded-lg px-3 py-2 bg-white/80 dark:bg-zinc-900/70 border-black/10 dark:border-white/10">
          </div>
          <div>
            <label class="block text-sm mb-1">個数</label>
            <input id="modalQtyInput" type="number" min="0" max="999" class="w-full border rounded-lg px-3 py-2 bg-white/80 dark:bg-zinc-900/70 border-black/10 dark:border-white/10">
          </div>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div>
            <label class="block text-sm mb-1">単位</label>
            <select id="modalUnit" class="w-full border rounded-lg px-3 py-2 bg-white/80 dark:bg-zinc-900/70 border-black/10 dark:border-white/10"></select>
          </div>
          <div>
            <label class="block text-sm mb-1">カテゴリ</label>
            <select id="modalCategory" class="w-full border rounded-lg px-3 py-2 bg-white/80 dark:bg-zinc-900/70 border-black/10 dark:border-white/10"></select>
          </div>
          <div>
            <label class="block text-sm mb-1">保管</label>
            <select id="modalLocation" class="w-full border rounded-lg px-3 py-2 bg-white/80 dark:bg-zinc-900/70 border-black/10 dark:border-white/10"></select>
          </div>
        </div>
        <div class="text-sm text-gray-500 dark:text-zinc-400">登録日</div>
        <div id="modalCreated" class="text-base"></div>
      </div>
      <div class="flex justify-end gap-2">
        <button id="modalSave" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">保存</button>
        <button id="modalOk"   class="px-4 py-2 rounded-lg bg-amber-500 text-white hover:bg-amber-600">閉じる</button>
      </div>
    </div>
  </div>

  <!-- 一括編集モーダル -->
  <div id="bulkModal" class="fixed inset-0 hidden items-center justify-center modal-bg z-50">
    <div class="bg-white dark:bg-zinc-900 w-11/12 max-w-md rounded-2xl shadow-xl p-5 space-y-4 border border-black/10 dark:border-white/10">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">一括編集</h3>
        <button id="bulkClose" class="text-gray-500 text-xl leading-none">&times;</button>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">消費期限（上書き）</label>
          <input id="bulkExpiry" type="date" class="w-full border rounded-lg px-3 py-2 bg-white/80 dark:bg-zinc-900/70 border-black/10 dark:border-white/10">
        </div>
        <div>
          <label class="block text-sm mb-1">個数（上書き）</label>
          <input id="bulkQty" type="number" min="0" max="999" class="w-full border rounded-lg px-3 py-2 bg-white/80 dark:bg-zinc-900/70 border-black/10 dark:border-white/10">
        </div>
        <div>
          <label class="block text-sm mb-1">単位</label>
          <select id="bulkUnit" class="w-full border rounded-lg px-3 py-2 bg-white/80 dark:bg-zinc-900/70 border-black/10 dark:border-white/10"></select>
        </div>
        <div>
          <label class="block text-sm mb-1">カテゴリ</label>
          <select id="bulkCategory" class="w-full border rounded-lg px-3 py-2 bg-white/80 dark:bg-zinc-900/70 border-black/10 dark:border-white/10"></select>
        </div>
        <div>
          <label class="block text-sm mb-1">保管</label>
          <select id="bulkLocation" class="w-full border rounded-lg px-3 py-2 bg-white/80 dark:bg-zinc-900/70 border-black/10 dark:border-white/10"></select>
        </div>
        <div class="flex items-center gap-2 mt-2">
          <input id="bulkArchive" type="checkbox" class="w-4 h-4"><label for="bulkArchive" class="text-sm">アーカイブにする</label>
        </div>
      </div>
      <div class="flex justify-end gap-2">
        <button id="bulkApply" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">適用</button>
      </div>
    </div>
  </div>

  <!-- Item Template（デザイン強化：card-glass クラス追加） -->
  <template id="tplItem">
    <div class="group border border-black/10 dark:border-white/10 rounded-2xl bg-white/80 dark:bg-zinc-900/60 shadow-soft overflow-hidden hover:shadow-xl transition card-glass">
      <div class="relative">
        <img class="card-img w-full h-44 object-cover cursor-pointer transition duration-300 group-hover:scale-[1.02]" />
        <button class="btn-del absolute top-2 right-2 bg-white/95 dark:bg-zinc-800/90 hover:bg-white dark:hover:bg-zinc-800 text-red-600 rounded-full p-2 shadow" title="削除">🗑️</button>
        <div class="absolute top-2 left-2">
          <span class="expiry-badge inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full bg-black/70 text-white">
            <span class="dot w-1.5 h-1.5 rounded-full bg-white/80"></span>
            <span class="badge-text">--</span>
          </span>
        </div>
        <div class="absolute bottom-2 left-2 flex gap-1">
          <span class="qty-badge text-[11px] px-2 py-0.5 rounded-full bg-emerald-600 text-white">x1</span>
          <span class="chip-unit text-[11px] px-2 py-0.5 rounded-full bg-black/60 text-white">個</span>
          <span class="chip-cat text-[11px] px-2 py-0.5 rounded-full bg-black/40 text-white"></span>
          <span class="chip-loc text-[11px] px-2 py-0.5 rounded-full bg-black/40 text-white"></span>
        </div>
      </div>
      <div class="p-3 space-y-2">
        <div class="flex items-center justify-between gap-2">
          <h3 class="name font-semibold truncate max-w-[60%]"></h3>
          <label class="inline-flex items-center gap-2 text-xs">
            <input type="checkbox" class="sel w-4 h-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-400" />
            <span class="hidden sm:inline text-gray-500 dark:text-zinc-400">選択</span>
          </label>
        </div>
        <div class="text-xs text-gray-500 dark:text-zinc-400 expiry"></div>
        <div class="h-1.5 rounded-full bg-black/5 dark:bg-white/10 overflow-hidden">
          <div class="progress h-1.5 rounded-full" style="width:0%; background: linear-gradient(90deg,#f59e0b,#f97316)"></div>
        </div>
      </div>
    </div>
  </template>

  <!-- Toast（Undo対応） -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[60] hidden">
    <div class="rounded-xl px-4 py-2 bg-black/80 text-white shadow-soft text-sm">
      <span id="toastMsg"></span>
      <button id="toastUndo" class="ml-3 underline">元に戻す</button>
    </div>
  </div>

  <script>

    // ===== helpers
    const $  = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));
    const clampInt = (v, min, max) => Math.max(min, Math.min(max, parseInt(v || 0, 10) || 0));

    // UI Refs
    const itemsEl = $('#items'), msgEl = $('#msg'), recipesEl = $('#recipes'), aiBadge = $('#aiBadge');
    const skeleton = $('#skeleton'), masterCheck = $('#masterCheck'), selCountEl = $('#selCount'), bulkBar = $('#bulkBar');
    const searchBox = $('#searchBox'), sortSelect = $('#sortSelect'), filterSelect = $('#filterSelect');
    const toggleZero = $('#toggleZero'), toggleArchived = $('#toggleArchived');
    const unitSel = $('#unit'), catSel = $('#category'), locSel = $('#location');
    const fileInput = $('#file'), drop = $('#dropzone'), previewEl = $('#preview');
    const btnUpload = $('#btnUpload'), btnSuggest = $('#btnSuggest'), btnRescan = $('#btnRescan'), btnTheme = $('#btnTheme');
    const toastBox = $('#toast'), toastMsg = $('#toastMsg'), toastUndo = $('#toastUndo');

    // Add form
    const expiryInput = $('#expiry'), qtyInput = $('#qty');

    // Modals
    const modal = $('#detailModal');
    const modalImg = $('#modalImg'), modalName = $('#modalName'), modalCreated = $('#modalCreated');
    const modalExpiryInput = $('#modalExpiryInput'), modalQtyInput = $('#modalQtyInput');
    const modalUnit = $('#modalUnit'), modalCategory = $('#modalCategory'), modalLocation = $('#modalLocation');
    const modalSave = $('#modalSave'), modalOk = $('#modalOk'), modalClose = $('#modalClose');

    // Bulk modal
    const bulkModal = $('#bulkModal'), bulkClose = $('#bulkClose'), bulkApply = $('#bulkApply');
    const bulkExpiry = $('#bulkExpiry'), bulkQty = $('#bulkQty'), bulkUnit = $('#bulkUnit'), bulkCategory = $('#bulkCategory'), bulkLocation = $('#bulkLocation'), bulkArchive = $('#bulkArchive');

    // Stats
    const statTotal = $('#statTotal'), statNear = $('#statNear'), statExpired = $('#statExpired');

    // State
    let items = [];
    let currentEditId = null;
    let lastDeletedIds = [];

    // ===== theme
    (function initTheme(){
      const saved = localStorage.getItem('theme');
      if (saved) document.documentElement.classList.toggle('dark', saved === 'dark');
      else document.documentElement.classList.toggle('dark', window.matchMedia('(prefers-color-scheme: dark)').matches);
    })();
    btnTheme.addEventListener('click', () => {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    function shopLinksHTML(keyword){
  const k = encodeURIComponent((keyword || '食材').trim());
  const links = [
    { name: 'Amazonフード', url: `https://www.amazon.co.jp/s?k=${k}&i=food-beverage` },
    { name: '楽天市場',     url: `https://search.rakuten.co.jp/search/mall/${k}/` },
    { name: 'Yahoo!ショッピング', url: `https://shopping.yahoo.co.jp/search?p=${k}` },
    { name: 'イオン ネットスーパー', url: `https://shop.aeon.com/netsuper/search/?keyword=${k}` },
    { name: 'Oisix', url: `https://www.oisix.com/SearchProduct.do?search=1&text=${k}` },
  ];
  return `
    <div class="mt-2 flex flex-wrap gap-2">
      ${links.map(l => `
        <a href="${l.url}" target="_blank" rel="noopener"
           class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-sm border border-black/10 dark:border-white/10 bg-white/80 dark:bg-zinc-900/70 hover:bg-black/5 dark:hover:bg-white/10 transition shadow-soft">
          🛒 ${l.name}
        </a>`).join('')}
    </div>`;
}

    // ===== toast + undo
    function showToast(msg, ids = []) {
      toastMsg.textContent = msg;
      lastDeletedIds = ids;
      toastBox.classList.remove('hidden');
      setTimeout(()=> toastBox.classList.add('hidden'), 3500);
    }
    toastUndo.addEventListener('click', async () => {
      if (!lastDeletedIds.length) return;
      try {
        const r = await fetch('/api/undo_delete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids: lastDeletedIds }) });
        await refresh();
      } catch {}
      toastBox.classList.add('hidden');
    });

    // ===== API
    async function apiMeta(){ const r = await fetch('/api/meta'); return await r.json(); }
    async function apiList(params){
      const qs = new URLSearchParams(params);
      const r = await fetch('/api/items?' + qs.toString());
      return await r.json();
    }
    async function apiUpload({expiry, quantity, unit, category, location, file}){
      const fd = new FormData();
      fd.append('name', '');
      fd.append('expiry', expiry || '');
      fd.append('quantity', String(quantity ?? 1));
      fd.append('unit', unit || '個');
      fd.append('category', category || '');
      fd.append('location', location || '冷蔵');
      fd.append('image', file);
      const r = await fetch('/api/items', { method:'POST', body:fd });
      if(!r.ok) throw new Error('upload failed');
      return await r.json();
    }
    async function apiDelete(id){
      const r = await fetch('/api/items/'+id, { method:'DELETE' });
      if(!r.ok){
        let m = 'delete failed'; try{ const j = await r.json(); m = j.error || m; }catch{}
        throw new Error(m);
      }
    }
    // 置き換え：apiBulkDelete だけ差し替え
    async function apiBulkDelete(ids){
      const r = await fetch('/api/items/bulk_delete', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ ids })
    });
    let j = {};
    try { j = await r.json(); } catch {}
    if(!r.ok){
      const msg = (j && j.error) ? j.error : `HTTP ${r.status}`;
      throw new Error(msg);
    }
    return j;
  }

    async function apiUpdate(id, payload){
      const r = await fetch('/api/items/'+id, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!r.ok) throw new Error('update failed'); return await r.json();
    }
    async function apiBulkUpdate(ids, patch){
      const r = await fetch('/api/items/bulk_update', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids, patch }) });
      if(!r.ok) throw new Error('bulk update failed'); return await r.json();
    }
    async function apiSuggest(ids, constraints={}){
      const r = await fetch('/api/recipes', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ item_ids: ids, constraints }) });
      if(!r.ok) throw new Error('recipes failed'); return await r.json();
    }
    async function apiRescan(){ const r = await fetch('/api/seed/rescan', { method:'POST' }); if(!r.ok) throw new Error('rescan failed'); return await r.json(); }

    // ===== query state & refresh
    const queryState = {
      q: '', sort: 'name', order: 'asc', filter: '', include_zero: false, include_archived: false
    };
    function getParams(){ return {
      query: queryState.q,
      sort: queryState.sort,
      order: queryState.order,
      filter: queryState.filter,
      include_zero: queryState.include_zero,
      include_archived: queryState.include_archived
    };}

    function parseSort(val){ const [s, o] = val.split('|'); return {s, o}; }

    function parseDate(yMd){ const d=new Date(yMd); return isNaN(d)?null:d; }
    function daysUntil(yMd){ const d=parseDate(yMd); if(!d)return null; const now=new Date(); return Math.ceil((d.setHours(0,0,0,0)-now.setHours(0,0,0,0))/86400000); }
    function expiryBadge(days){
      if(days===null) return {text:'期限不明',cls:'bg-black/70'};
      if(days<0)      return {text:'期限切れ',cls:'bg-rose-600'};
      if(days===0)    return {text:'本日まで',cls:'bg-amber-600'};
      if(days<=2)     return {text:`残り${days}日`,cls:'bg-amber-500'};
      if(days<=7)     return {text:`残り${days}日`,cls:'bg-emerald-600'};
      return {text:`残り${days}日`,cls:'bg-emerald-500'};
    }
    function progressPct(createdISO, expiry){
      if(!createdISO||!expiry) return 0;
      const c=new Date(createdISO).getTime(), e=new Date(expiry).getTime(), n=Date.now();
      if(isNaN(c)||isNaN(e)||e<=c) return 0;
      return Math.min(100, Math.max(0, ((n-c)/(e-c))*100));
    }

    // ===== stats
    function updateStats(){
      const total = items.length;
      const near  = items.filter(it=>{
        const d = it.expiry ? daysUntil(it.expiry) : null;
        return d!==null && d>=0 && d<=2 && !it.is_archived && (it.quantity??0)>0;
      }).length;
      const expired = items.filter(it=>{
        const d = it.expiry ? daysUntil(it.expiry) : null;
        return d!==null && d<0 && !it.is_archived && (it.quantity??0)>0;
      }).length;
      statTotal.textContent = total;
      statNear.textContent = near;
      statExpired.textContent = expired;
      // 軽い演出
      statTotal.classList.add('animate-pop'); setTimeout(()=>statTotal.classList.remove('animate-pop'),220);
      statNear.classList.toggle('animate-pulse', near>0);
      statExpired.classList.toggle('animate-pulse', expired>0);
    }

    function showEmptyState(){
  const links = shopLinksHTML('食材');
  itemsEl.innerHTML = `
    <div class="col-span-full">
      <div class="grid place-items-center p-10 border border-dashed rounded-3xl text-center bg-white/60 dark:bg-zinc-900/50 border-black/10 dark:border-white/10">
        <div class="text-6xl mb-2">🥬</div>
        <p class="font-medium">まだ食材がありません</p>
        <div class="mb-3">
          ${links}
        </div>
      </div>
    </div>`;
  recipesEl.textContent = '冷蔵庫が空です。食材を追加してください。';
  aiBadge.classList.add('hidden');
}


    function renderItems(){
      skeleton.classList.add('hidden');
      itemsEl.classList.remove('hidden');
      itemsEl.innerHTML = '';
      const allZero = items.length > 0 && items.every(it => (it.quantity ?? 0) === 0);

      if(!items.length || allZero){ showEmptyState(); updateStats(); return; }


      const tpl = $('#tplItem').content;
      items.forEach((it)=>{
        const node = tpl.cloneNode(true);
        const card = node.firstElementChild;

        const imgEl = node.querySelector('.card-img');
        imgEl.src = it.image_url; imgEl.alt = it.name || '食材画像';
        imgEl.addEventListener('click', ()=> openDetail(it));

        node.querySelector('.name').textContent   = it.name || '(名称未設定)';
        node.querySelector('.expiry').textContent = it.expiry ? `消費期限: ${it.expiry}` : '消費期限: ー';

        // 期限バッジ
        const d = it.expiry ? daysUntil(it.expiry) : null;
        const badge = expiryBadge(d);
        const badgeEl = node.querySelector('.expiry-badge');
        badgeEl.className = `expiry-badge inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full text-white ${badge.cls}`;
        badgeEl.querySelector('.badge-text').textContent = badge.text;

        // 個数/単位/カテゴリ/保管チップ
        const q = typeof it.quantity === 'number' ? it.quantity : 1;
        const qtyBadge = node.querySelector('.qty-badge');
        qtyBadge.textContent = q === 0 ? '在庫なし' : `x${q}`;
        qtyBadge.className = `qty-badge text-[11px] px-2 py-0.5 rounded-full ${ q === 0 ? 'bg-slate-500 text-white' : 'bg-emerald-600 text-white' }`;
        node.querySelector('.chip-unit').textContent = it.unit || '個';
        node.querySelector('.chip-cat').textContent = it.category || '';
        node.querySelector('.chip-loc').textContent = it.location || '';

        if (q === 0 || it.is_archived) card.classList.add('opacity-70', 'grayscale'); else card.classList.remove('opacity-70','grayscale');

        // 進捗バー
        const pct = progressPct(it.created_at, it.expiry);
        node.querySelector('.progress').style.width = pct + '%';

        // 選択（data-idベース）
        const sel = node.querySelector('.sel');
        sel.dataset.id = it.id;
        sel.addEventListener('change', updateSelCount);

        // 単体削除
        node.querySelector('.btn-del').addEventListener('click', async (e)=>{
          e.stopPropagation();
          if(!confirm(`「${it.name || 'この食材'}」を削除しますか？`)) return;
          try{
            await apiDelete(it.id);
            items = items.filter(x=>x.id!==it.id);
            renderItems(); updateSelCount();
            showToast('削除しました', [it.id]);
          }catch(err){ alert('削除に失敗しました: ' + err.message); }
        });

        itemsEl.appendChild(node);
      });

      if (recipesEl.textContent && recipesEl.textContent.includes('冷蔵庫が空です')) {
        recipesEl.textContent = '';
      }
      updateStats();
    }

    function openDetail(it){
      currentEditId = it.id;
      modalImg.src = it.image_url;
      modalName.textContent = it.name || '(名称未設定)';
      modalCreated.textContent = it.created_at ? new Date(it.created_at).toLocaleString() : 'ー';
      modalExpiryInput.value = it.expiry || '';
      modalQtyInput.value = typeof it.quantity === 'number' ? it.quantity : 1;
      modalUnit.value = it.unit || '個';
      modalCategory.value = it.category || '';
      modalLocation.value = it.location || '冷蔵';
      modal.classList.remove('hidden'); modal.classList.add('flex');
    }
    function closeDetail(){ modal.classList.add('hidden'); modal.classList.remove('flex'); currentEditId = null; }

    function getSelectedIds(){
      return [...itemsEl.querySelectorAll('.sel')].filter(cb=>cb.checked).map(cb=>cb.dataset.id).filter(Boolean);
    }
    function updateSelCount(){
      const n = getSelectedIds().length;
      selCountEl.textContent = `${n} 件選択中`;
      bulkBar.classList.toggle('hidden', n === 0);
      masterCheck.indeterminate = (n > 0 && n < items.length);
      masterCheck.checked = (n === items.length && items.length > 0);
    }

    function renderRecipes(data){
      const fromAI = data?.source === 'ai';
      if (fromAI) aiBadge.classList.remove('hidden'); else aiBadge.classList.add('hidden');

      if (!data || !data.recipes || !data.recipes.length){
        recipesEl.textContent = '候補が見つかりませんでした。';
        return;
      }
      recipesEl.innerHTML = '';
      data.recipes.forEach((r, idx)=>{
        const tags = (r.tags || []).map(t=>`<span class="text-[11px] px-2 py-0.5 rounded-full bg-black/5 dark:bg-white/10">${t}</span>`).join(' ');
        const ing  = (r.ingredients||[]).map(x=> `<span class="inline-block mb-1 px-2 py-0.5 bg-black/5 dark:bg-white/10 rounded">${x}</span>`).join(' ');
        const steps = (r.steps||[]).map((s,i)=> `<li class="ml-1">${i+1}. ${s}</li>`).join('');
        const meta = `
          <div class="flex flex-wrap items-center gap-2 text-xs text-gray-500 dark:text-zinc-400 mt-1">
            ${r.time ? `<span>⏱ ${r.time}</span>` : '' }
            ${r.servings ? `<span>🍽 ${r.servings}人分</span>` : '' }
            ${tags ? `<span class="inline-flex gap-1">${tags}</span>` : ''}
          </div>`;
        const url = r.url ? `<a class="inline-flex items-center gap-1 text-blue-600 dark:text-blue-400 underline" href="${r.url}" target="_blank" rel="noopener">似たレシピを探す</a>` : '';
        const box = document.createElement('div');
        box.className = 'p-4 border rounded-2xl bg-white/70 dark:bg-zinc-900/50 border-black/10 dark:border-white/10 shadow-soft';
        box.innerHTML = `
          <div class="flex items-baseline gap-3">
            <span class="text-sm text-gray-400">#${idx+1}</span>
            <h3 class="font-semibold text-lg">${r.title || 'レシピ'}</h3>
          </div>
          ${meta}
          <div class="mt-2 space-x-1">${ing}</div>
          <ol class="mt-2 space-y-1 list-decimal list-inside">${steps}</ol>
          <div class="mt-3">${url}</div>`;
        recipesEl.appendChild(box);
      });
    }

    async function refresh(){
      try {
        items = await apiList(getParams());
      } catch {
        items = [];
        recipesEl.textContent = 'データ取得に失敗しました。';
      }
      renderItems(); updateSelCount();
    }

    // ===== init meta（セレクトに反映）
    (async ()=>{
      const meta = await apiMeta();
      const fill = (sel, arr) => { sel.innerHTML = arr.map(v=> `<option value="${v}">${v||'（なし）'}</option>`).join(''); };
      fill(unitSel, meta.units); fill(catSel, meta.categories); fill(locSel, meta.locations);
      // モーダル＆バルク
      const modalUnit = $('#modalUnit'), modalCategory = $('#modalCategory'), modalLocation = $('#modalLocation');
      const bulkUnit = $('#bulkUnit'), bulkCategory = $('#bulkCategory'), bulkLocation = $('#bulkLocation');
      fill(modalUnit, meta.units); fill(modalCategory, meta.categories); fill(modalLocation, meta.locations);
      fill(bulkUnit, ['','(変更しない)'].concat(meta.units)); fill(bulkCategory, ['','(変更しない)'].concat(meta.categories)); fill(bulkLocation, ['','(変更しない)'].concat(meta.locations));
      await refresh();
    })();

    // ===== events: controls
    let searchTimer;
    searchBox.addEventListener('input', ()=>{
      clearTimeout(searchTimer);
      searchTimer = setTimeout(()=>{ queryState.q = searchBox.value.trim(); refresh(); }, 250);
    });
    sortSelect.addEventListener('change', ()=>{
      const {s,o} = parseSort(sortSelect.value); queryState.sort=s; queryState.order=o; refresh();
    });
    filterSelect.addEventListener('change', ()=>{ queryState.filter = filterSelect.value; refresh(); });
    toggleZero.addEventListener('change', ()=>{ queryState.include_zero = toggleZero.checked; refresh(); });
    toggleArchived.addEventListener('change', ()=>{ queryState.include_archived = toggleArchived.checked; refresh(); });

    // クイックフィルタ（フィルタセレクトと同期）
    $$('.qf').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const v = btn.dataset.filter || '';
        filterSelect.value = v; queryState.filter = v; refresh();
        $$('.qf').forEach(b=> b.classList.remove('ring-2','ring-amber-400/60'));
        btn.classList.add('ring-2','ring-amber-400/60');
      });
    });

    masterCheck.addEventListener('change', ()=>{
      const all = [...itemsEl.querySelectorAll('.sel')];
      all.forEach(cb => { cb.checked = masterCheck.checked; });
      updateSelCount();
    });

    // ===== add / upload
    function showPreview(file){
      const url = URL.createObjectURL(file);
      previewEl.classList.remove('hidden');
      previewEl.innerHTML = `<div class="flex items-center gap-2">
        <img src="${url}" alt="preview" class="w-10 h-10 object-cover rounded-md border border-black/10 dark:border-white/10">
        <span class="truncate">${file.name}</span></div>`;
    }
    drop.addEventListener('click', ()=> fileInput.click());
    drop.addEventListener('dragover', (e)=> { e.preventDefault(); drop.classList.add('dragover'); });
    drop.addEventListener('dragleave', ()=> drop.classList.remove('dragover'));
    drop.addEventListener('drop', (e)=>{ e.preventDefault(); drop.classList.remove('dragover'); if(e.dataTransfer.files.length){ fileInput.files = e.dataTransfer.files; showPreview(fileInput.files[0]); }});
    fileInput.addEventListener('change', ()=> { if(fileInput.files[0]) showPreview(fileInput.files[0]); });

    btnUpload.addEventListener('click', async ()=>{
      const file = fileInput.files[0];
      if(!file){ alert('画像ファイルを選択してください'); return; }
      try{
        msgEl.textContent = 'アップロード中…';
        const item = await apiUpload({
          expiry: expiryInput.value,
          quantity: clampInt(qtyInput.value,0,999),
          unit: unitSel.value, category: catSel.value, location: locSel.value,
          file
        });
        items.push(item); renderItems(); updateSelCount();
        fileInput.value = ''; previewEl.classList.add('hidden'); previewEl.innerHTML = '';
        expiryInput.value = ''; qtyInput.value = '1';
        msgEl.textContent = '追加しました';
        setTimeout(()=> msgEl.textContent = '', 2000);
      }catch{ alert('アップロードに失敗しました'); msgEl.textContent = ''; }
    });

    // ===== suggest (AI)
    const btnOldSuggestHTML = btnSuggest.innerHTML;
    btnSuggest.addEventListener('click', async ()=>{
      try{
        btnSuggest.disabled = true;
        btnSuggest.innerHTML = `<svg class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-opacity=".25" stroke-width="3"/><path d="M21 12a9 9 0 0 1-9 9" stroke="currentColor" stroke-width="3"/></svg> AIで献立生成中…`;
        const data = await apiSuggest(getSelectedIds(), {/* constraints 例: max_time: 20 */});
        if((data.ingredients||[]).length===0 && items.length===0){ recipesEl.textContent = '冷蔵庫が空です。'; aiBadge.classList.add('hidden'); }
        else { renderRecipes(data); }
      }catch{
        recipesEl.textContent = 'レシピ生成に失敗しました。'; aiBadge.classList.add('hidden');
      }finally{
        btnSuggest.innerHTML = btnOldSuggestHTML; btnSuggest.disabled = false;
      }
    });

    // ===== seed rescan
    const btnOldRescanHTML = btnRescan.innerHTML;
    btnRescan.addEventListener('click', async ()=>{
      try{
        btnRescan.disabled = true;
        btnRescan.innerHTML = `<svg class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-opacity=".25" stroke-width="3"/><path d="M21 12a9 9 0 0 1-9 9" stroke="currentColor" stroke-width="3"/></svg> 実行中…`;
        msgEl.textContent = '実行中…';
        const r = await apiRescan();
        if (r.found === 0) msgEl.textContent = 'seedフォルダに画像がありません'; else msgEl.textContent = `seed ${r.found}件中 ${r.added}件 新規`;
        await refresh();
      }catch{ msgEl.textContent = 'スキャンに失敗しました'; }
      finally{
        btnRescan.innerHTML = btnOldRescanHTML; btnRescan.disabled = false; setTimeout(()=> msgEl.textContent = '', 2500);
      }
    });

    // ===== detail modal
    function openDetail(it){
  currentEditId = it.id;
  modalImg.src = it.image_url;
  modalName.textContent = it.name || '(名称未設定)';
  modalCreated.textContent = it.created_at ? new Date(it.created_at).toLocaleString() : 'ー';
  modalExpiryInput.value = it.expiry || '';
  modalQtyInput.value = typeof it.quantity === 'number' ? it.quantity : 1;
  modalUnit.value = it.unit || '個';
  modalCategory.value = it.category || '';
  modalLocation.value = it.location || '冷蔵';

  // ▼ ここが追加：この食材名で買えるサイトリンクを表示
  const buyLinks = document.getElementById('buyLinks');
  if (buyLinks) buyLinks.innerHTML = `
    <div class="text-gray-500 dark:text-zinc-400 mb-1">この食材を買う</div>
    ${shopLinksHTML(it.name || '食材')}
  `;

  modal.classList.remove('hidden'); 
  modal.classList.add('flex');
}

    function closeDetail(){ modal.classList.add('hidden'); modal.classList.remove('flex'); currentEditId = null; }
    modalClose.addEventListener('click', closeDetail); modalOk.addEventListener('click', closeDetail);
    modal.addEventListener('click', (e)=> { if(e.target===modal) closeDetail(); });

    modalSave.addEventListener('click', async ()=>{
      if(!currentEditId) return;
      try{
        await apiUpdate(currentEditId, {
          expiry: (modalExpiryInput.value || "").trim(),
          quantity: clampInt(modalQtyInput.value, 0, 999),
          unit: modalUnit.value, category: modalCategory.value, location: modalLocation.value
        });
        await refresh(); closeDetail();
      }catch{ alert('更新に失敗しました'); }
    });

    // ===== bulk actions
    const btnBulkDelete = $('#btnBulkDelete'), btnBulkArchive = $('#btnBulkArchive'), btnBulkZero = $('#btnBulkZero'), btnBulkEdit = $('#btnBulkEdit');

    // 置き換え：btnBulkDelete の catch を改善
    btnBulkDelete.addEventListener('click', async ()=>{
      const ids = getSelectedIds(); if(!ids.length) return;
      if(!confirm(`${ids.length}件を削除しますか？`)) return;
        try{
        const res = await apiBulkDelete(ids);
        showToast('削除しました', res.deleted || ids);
        await refresh();
        }catch(e){
        alert('一括削除に失敗しました: ' + (e?.message || 'unknown error'));
        }
        });


    btnBulkArchive.addEventListener('click', async ()=>{
      const ids = getSelectedIds(); if(!ids.length) return;
      try{ await apiBulkUpdate(ids, { is_archived: true }); await refresh(); }catch{ alert('アーカイブに失敗しました'); }
    });

    btnBulkZero.addEventListener('click', async ()=>{
      const ids = getSelectedIds(); if(!ids.length) return;
      try{ await apiBulkUpdate(ids, { quantity: 0 }); await refresh(); }catch{ alert('在庫0に失敗しました'); }
    });

    btnBulkEdit.addEventListener('click', ()=>{
      bulkModal.classList.remove('hidden'); bulkModal.classList.add('flex');
    });
    document.addEventListener('mousemove', (e)=>{
    const ang = (e.clientX / window.innerWidth) * 360;
    document.documentElement.style.setProperty('--ang', ang.toFixed(1)+'deg');
    }, {passive:true});

    function closeBulk(){ bulkModal.classList.add('hidden'); bulkModal.classList.remove('flex'); }
    bulkClose.addEventListener('click', closeBulk);
    bulkModal.addEventListener('click', (e)=>{ if(e.target===bulkModal) closeBulk(); });
    bulkApply.addEventListener('click', async ()=>{
      const ids = getSelectedIds(); if(!ids.length) return;
      const patch = {};
      if (bulkExpiry.value) patch.expiry = bulkExpiry.value;
      if (bulkQty.value)    patch.quantity = clampInt(bulkQty.value,0,999);
      if (bulkUnit.value && bulkUnit.value !== '(変更しない)') patch.unit = bulkUnit.value;
      if (bulkCategory.value && bulkCategory.value !== '(変更しない)') patch.category = bulkCategory.value;
      if (bulkLocation.value && bulkLocation.value !== '(変更しない)') patch.location = bulkLocation.value;
      if (bulkArchive.checked) patch.is_archived = true;
      try{ await apiBulkUpdate(ids, patch); await refresh(); closeBulk(); }catch{ alert('一括編集に失敗しました'); }
      function attachTilt(selector, max=8){
      document.querySelectorAll(selector).forEach(el=>{
      el.style.transformStyle = 'preserve-3d';
      el.addEventListener('mousemove', (e)=>{
      const r = el.getBoundingClientRect();
      const px = (e.clientX - r.left) / r.width;
      const py = (e.clientY - r.top)  / r.height;
      const rx = (py - .5) * -2 * max;
      const ry = (px - .5) *  2 * max;
      el.style.transform = `perspective(900px) rotateX(${rx}deg) rotateY(${ry}deg)`;
      el.style.setProperty('--mx', `${px*100}%`);
      el.style.setProperty('--my', `${py*100}%`);
      });
      el.addEventListener('mouseleave', ()=>{
      el.style.transform = 'perspective(900px) rotateX(0) rotateY(0)';
      el.style.setProperty('--mx','40%');
      el.style.setProperty('--my','35%');
      });
    });
  }
attachTilt('.card-glass', 6);

    });

    // ===== start
    (async ()=>{ skeleton.classList.remove('hidden'); itemsEl.classList.add('hidden'); await refresh(); })();
  </script>

  <!-- Footer -->
  <footer class="max-w-7xl mx-auto px-6 pb-10 pt-6 text-xs text-gray-500 dark:text-zinc-400">
    <div class="border-t border-black/10 dark:border-white/10 pt-4">
      <span>🍱 フードマネージャー</span>
    </div>
  </footer>
</body>
</html>
